# 风云众数据预处理工具

集成风云众原始数据预处理流程，包括视频重命名、对齐视频

## 0. 准备工作

音视频对齐工具下载，在fyz_video_preprocess下执行：
``` bash
git clone https://github.com/align-videos-by-sound/align-videos-by-sound.git
cd align-videos-by-sound/
python3 setup.py install
cd ..
cp -R align-videos-by-sound/align_videos_by_soundtrack ./
rm -rf align-videos-by-sound
```

然后打开align_videos_by_soundtrack里的_cache.py，comment掉第24行的os.environ["HOME"]，如下：
``` _cache.py
try:
    cache_root_dir
except NameError:
    pkgroot = "align_videos_by_soundtrack"
    if sys.platform == "win32":
        cache_root_dir = os.path.join(
            os.environ["LOCALAPPDATA"],
            pkgroot, "%s" % __version__, "Cache")
    else:
        cache_root_dir = os.path.join(
            # os.environ["HOME"],
            "." + pkgroot, "%s" % __version__, "Cache")
```

## 1. 视频命名检查

风云众一些原始视频的命名有误，需要手动筛查
在settings.py里选择存储风云众视频的hdfs根路径，如下：
``` settings.py
HDFS_ROOT_DIRECTORY = 'hdfs://hobot-bigdata/user/jianxi.wang/data/FYZ/2021_06_29'
HDFS_OUTPUT_DIRECTORY = 'hdfs://hobot-bigdata/user/jianxi.wang/data/FYZ/FYZ_multimodal_batch02'
HDFS_TEMP_STORAGE = 'hdfs://hobot-bigdata/user/jianxi.wang/FYZ_SYNC/batch02_29'
LOCAL_ROOT_DIRECTORY = os.path.join('checkonly', HDFS_ROOT_DIRECTORY[HDFS_ROOT_DIRECTORY.rfind('/'):].lstrip('/'))
```

仅需要修改这3个变量：
HDFS_ROOT_DIRECTORY - 存储风云众视频的hdfs根路径
HDFS_OUTPUT_DIRECTORY - 预处理完成的视频的hdfs根路径
HDFS_TEMP_STORAGE - MR的打印输出存储路径

然后执行：
``` bash
python3 fyz_preprocess.py stage_1
```
即可在checkonly/*/stacked_image路径下获取基于同id生成的九宫格照片
将所有九宫格照片下载，检查角度是否正确（应都看向中心），检查是否是同一个人
在检查的过程中如果发现有任何错误的命名，都应该记录在errlog_fixname.txt中

错误种类及记录格式参见下表：
-------------------------------------------------------------------------------------------------------
|   错误类型   |                 错误描述（例）                 |              错误记录格式              |
-------------------------------------------------------------------------------------------------------
|   格式错误   |       0022左下角视频文件格式为mp4，不是MOV      |          0022_左下：mp4文件格式        |
-------------------------------------------------------------------------------------------------------
|   人物错误   |         0028右下角人物实际是0027的右下角        |    0028_右下：命名错误，改为0027_右下   |
-------------------------------------------------------------------------------------------------------
|   角度错误   |           1166中的角度实际是1166中上           |     1166_中：命名错误，改为1166_中上    |
-------------------------------------------------------------------------------------------------------
|   其他错误   |   1381右上角无法以修改命名的方式匹配任何一个人   |        1381_右上：命名错误，删除        |
-------------------------------------------------------------------------------------------------------

附上一个errlog_fixname.txt范例：
``` errlog_fixname.txt
0022_左下：mp4文件格式
0028_右下：命名错误，改为0027_右下
0029_右下：命名错误，改为0028_右下
0031_右下：mp4文件格式
0032_右下：mp4文件格式
0033_右下：mp4文件格式
0034_右下：mp4文件格式
0035_右下：mp4文件格式
0036_右下：mp4文件格式
0037_右下：mp4文件格式
0038_右下：mp4文件格式
0039_右下：mp4文件格式
0040_右下：mp4文件格式
0041_右下：mp4文件格式
0042_右下：mp4文件格式
0105_中：命名错误，改为0117_中
0109_中：命名错误，改为0143_中
0117_中：命名错误，改为0109_中
0125_中：命名错误，改为0105_中
0129_中：命名错误，改为0125_中
0132_中：命名错误，改为0136_中
0136_中：命名错误，改为0129_中
0137_中：命名错误，改为0147_中
0138_左上：命名错误，改为0139_左上
0143_中：命名错误，改为0137_中
0147_中：命名错误，改为0132_中
1195_中上：命名错误，改为1195_中
1195_中：命名错误，改为1195_中上
1199_中上：命名错误，改为1199_中
1199_中：命名错误，改为1199_中上
1255_左中：命名错误，改为1256_左中
1258_左下：命名错误，改为1458_左下
1265_左中：命名错误，改为1255_左中
1275_左中：命名错误，改为1265_左中
1281_左下：命名错误，改为1381_左下
1319_右中：命名错误，改为1379_右中
1323_右中：命名错误，改为1390_右中
1337_右中：命名错误，改为1429_右中
1340_右中：命名错误，改为1459_右中
1344_右中：命名错误，改为1451_右中
1345_右中：命名错误，改为1425_右中
1348_右中：命名错误，改为1427_右中
1349_右中：命名错误，改为1428_右中
1354_右中：命名错误，改为1411_右中
1356_右中：命名错误，改为1421_右中
1357_右中：命名错误，改为1415_右中
1362_右中：命名错误，改为1461_右中
1368_右中：命名错误，改为1424_右中
1369_右中：命名错误，改为1450_右中
1370_右中：命名错误，改为1371_右中
1371_右中：命名错误，改为1394_右中
1374_右中：命名错误，改为1460_右中
1375_右中：命名错误，改为1405_右中
1378_右中：命名错误，改为1389_右中
1379_右中：命名错误，改为1345_右中
1381_右上：命名错误，删除
1383_右下：命名错误，改为1466_右下
1389_右中：命名错误，改为1375_右中
1390_右中：命名错误，改为1349_右中
1391_右中：命名错误，改为1468_右中
1392_右中：命名错误，改为1469_右中
1394_右中：命名错误，改为1393_右中
1395_右中：命名错误，改为1323_右中
1396_右中：命名错误，改为1470_右中
1397_右中：命名错误，改为1319_右中
1398_右中：命名错误，改为1356_右中
1399_右中：命名错误，改为1370_右中
1400_右中：命名错误，改为1340_右中
1401_右中：命名错误，改为1400_右中
1405_右中：命名错误，改为1406_右中
1406_右中：命名错误，改为1399_右中
1408_右中：命名错误，改为1337_右中
1409_右中：命名错误，改为1357_右中
1411_右中：命名错误，改为1374_右中
1415_右中：命名错误，改为1354_右中
1417_右中：命名错误，改为1422_右中
1418_右中：命名错误，改为1430_右中
1421_右中：命名错误，改为1348_右中
1422_右中：命名错误，改为1378_右中
1423_右中：命名错误，改为1418_右中
1424_右中：命名错误，改为1391_右中
1425_右中：命名错误，改为1369_右中
1427_右中：命名错误，改为1362_右中
1428_右中：命名错误，改为1344_右中
1429_右中：命名错误，改为1368_右中
1430_右中：命名错误，改为1433_右中
1433_右中：命名错误，改为1417_右中
1450_右中：命名错误，改为1392_右中
1451_右中：命名错误，改为1396_右中
1452_右中：命名错误，改为1423_右中
1453_右中：命名错误，改为1452_右中
1458_右中：命名错误，改为1453_右中
1459_右中：命名错误，改为1458_右中
1460_右中：命名错误，改为1395_右中
1461_右中：命名错误，改为1397_右中
1466_右下：命名错误，改为1383_右下
1468_右中：命名错误，改为1398_右中
1469_右中：命名错误，改为1409_右中
1470_右中：命名错误，改为1408_右中
1489_右上：命名错误，改为1380_右上
1491_右上：命名错误，改为1401_右上
1497_右下：命名错误，改为1407_右下
1499_左中：命名错误，改为1400_左中
1499_右上：命名错误，改为1400_右上
4364_右上：命名错误，改为4365_右上
5120_中下：命名错误，改为5129_中下
2021_06_10_10_33_IMG_0845_右下：命名错误，改为0076_右下
2021_06_10_11_00_IMG_0846_右下：命名错误，改为0079_右下
2021_06_10_11_45_IMG_0847_右下：命名错误，改为0082_右下
2021_06_10_12_07_IMG_0849_右下：命名错误，改为0083_右下
070_左下：命名错误，改为0070_左下
130_左下：命名错误，改为1380_左下
142_左上：命名错误，改为1442_左上
1161_中上：命名错误，改为1161_中
1161_中：命名错误，改为1161_中上
1163_中上：命名错误，改为1163_中
1163_中：命名错误，改为1163_中上
1166_中上：命名错误，改为1166_中
1166_中：命名错误，改为1166_中上
1170_中上：命名错误，改为1170_中
1170_中：命名错误，改为1170_中上
1171_中上：命名错误，改为1171_中
1171_中：命名错误，改为1171_中上
1174_中上：命名错误，改为1174_中
1174_中：命名错误，改为1174_中上
1176_中上：命名错误，改为1176_中
1176_中：命名错误，改为1176_中上
1182_中上：命名错误，改为1182_中
1182_中：命名错误，改为1182_中上
1191_中上：命名错误，改为1191_中
1191_中：命名错误，改为1191_中上
```

## 2. 视频命名修复+更新

确认第一步完成后执行：
``` bash
python3 fyz_preprocess.py stage_2
```
即可完成hdfs端的视频命名更新

## 3. 视频同步及检查

执行：
``` bash
python3 fyz_preprocess.py stage_3
python3 fyz_preprocess.py extract_stacked_videos
```
获得同步视频，检查同步性及其他问题，并在errlog_notsync.txt里记录
错误记录规则：
1. 所有错误种类都可以在utils/settings.py里的ERROR_TYPE定义，存在于ERROR_TYPE里的错误将不会被删除， 并会在执行下面的“4. 收尾”后存储于tar包中
2. 未被定义的错误将自动视为删除

附上一个ERROR_TYPE + errlog_notsync.txt范例：

``` settings.py
ERROR_TYPE = {
    '尺寸错误'
}
```

``` errlog_notsync.txt
0021_右下：删除
0030_右下：删除
0043_中下：尺寸错误
0044_中下：尺寸错误
0045_中下：尺寸错误
0046_中下：尺寸错误
0056_左下：删除
0079_中下：删除
0080_右下：尺寸错误
0081_右下：尺寸错误
0082_中下：删除
1244_左上：尺寸错误
1256_左上：尺寸错误
1264_左上：尺寸错误
1313_左中：变形
1313_右中：尺寸错误
1318_左中：变形
1324_右中：尺寸错误
1325_右中：尺寸错误
1327_右中：尺寸错误
1328_左中：变形
1328_右中：尺寸错误
1338_右中：尺寸错误
1339_右中：尺寸错误
1341_左中：变形
1341_右中：尺寸错误
1342_左中：变形
1342_右中：尺寸错误
1351_右中：尺寸错误
1357_左下：遮挡严重
1358_右中：尺寸错误
1359_右中：尺寸错误
1379_中上：删除
5152_左下：删除
```
在这个例子中，只有“尺寸错误”被定义了下来，因此“删除”，“变形”和“遮挡严重”的视频将在hdfs上被自动删除，而“尺寸错误”会被保留下来

## 4. 收尾

执行：
``` bash
python3 fyz_preprocess.py stage_4
```
可获得定义好的错误的tar包，包含错误相关视频，同时删除其他有错误但未被定义的同步视频

## 注意
stage_1在运行MR时中途报错属正常现象，不影响结果
